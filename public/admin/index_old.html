<script>
  window.CMS_MANUAL_INIT = true;
</script>
<script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js" defer></script>
<script>
  const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';

  const config = {
    load_config_file: false,
    backend: isLocal
      ? { name: 'test-repo', branch: 'main' }     // local
      : { name: 'git-gateway', branch: 'main' },  // Netlify prod
    local_backend: isLocal,                       // IMPORTANT: false en prod
    media_folder: 'public/photos',
    public_folder: '/photos',
    publish_mode: 'editorial_workflow',
    collections: [
      {
        name: 'series',
        label: 'Séries',
        folder: 'content/series',
        create: true,
        slug: '{{slug}}',
        fields: [
          { label: 'Titre', name: 'title', widget: 'string' },
          { label: 'Slug',  name: 'slug',  widget: 'string' },
          { label: 'Texte', name: 'body',  widget: 'markdown' },
          {
            label: 'Photos',
            name: 'images',
            widget: 'list',
            fields: [
              { label: 'Image',   name: 'url',     widget: 'image' },
              { label: 'Titre',   name: 'title',   widget: 'string', required: false },
              { label: 'Légende', name: 'caption', widget: 'text',   required: false },
            ],
          },
        ],
      },
    ],
  };

  function initCMS(tries = 200) {
    if (window.CMS?.init) CMS.init({ config });
    else if (tries) setTimeout(() => initCMS(tries - 1), 50);
    else console.error('Decap CMS introuvable');
  }
  addEventListener('DOMContentLoaded', initCMS);
</script>