<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="robots" content="noindex" />
    <title>Raph Photo CMS</title>
    <!-- 1) Empêcher l’auto-init de Decap -->
    <script>
      window.CMS_MANUAL_INIT = true;
    </script>
    <!-- 2) Charger Decap en différé (après le parsing du body) -->
    <script
      src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"
      defer
    ></script>
  </head>
  <body>
    <div id="cms-root"></div>

    <!-- 3) Initialiser quand le script est vraiment disponible -->
    <script>
      const config = {
        load_config_file: false, // on évite /admin/config.yml pour l’instant
        local_backend: true, // tests en local
        backend: { name: "test-repo", branch: "main" },
        media_folder: "public/photos",
        public_folder: "/photos",
        publish_mode: "editorial_workflow",
        collections: [
          {
            name: "series",
            label: "Séries",
            folder: "content/series",
            create: true,
            slug: "{{slug}}",
            fields: [
              { label: "Titre", name: "title", widget: "string" },
              { label: "Slug", name: "slug", widget: "string" },
              { label: "Texte", name: "body", widget: "markdown" },
              {
                label: "Photos",
                name: "images",
                widget: "list",
                fields: [
                  { label: "Image", name: "url", widget: "image" },
                  {
                    label: "Titre",
                    name: "title",
                    widget: "string",
                    required: false,
                  },
                  {
                    label: "Légende",
                    name: "caption",
                    widget: "text",
                    required: false,
                  },
                ],
              },
            ],
          },
        ],
      };

      function initWhenReady(retries = 200) {
        if (window.CMS && typeof window.CMS.init === "function") {
          window.CMS.init({ config });
        } else if (retries > 0) {
          setTimeout(() => initWhenReady(retries - 1), 50);
        } else {
          console.error("Decap CMS n'a pas pu être chargé.");
        }
      }

      // Attendre le DOM ET que decap-cms.js soit chargé (defer)
      window.addEventListener("DOMContentLoaded", () => initWhenReady());
    </script>
  </body>
</html>
